# Implementation Plan

- [x] 1. 運用設定とトリガー基盤を用意する
- [x] 1.1 スクリプト設定値と運用ドキュメントを整備する
  - 本番スプレッドシートID、Discord Bot Token、フォーラムチャンネルID、プロジェクトごとの最大処理件数などを Script Properties / Secrets Manager に保存し、ローカルサンプルを参照しない前提をコメントで残す。
  - 30 分以外のトリガーを採用しない理由を運用ノートに明記し、シート更新トリガー無効化ポリシーを記述する。
  - Config モジュールには JSDoc コメントを付与し、ホバー時に説明が出るよう型情報と日本語メッセージを整備する。
  - _Requirements: 1.5, 4.5_
- [x] 1.2 トリガー登録とベースロギングを構築する
  - GAS のトリガー設定は UI で行う前提とし、コード側では `syncCycle` を直接実行できるよう `createTimeTriggerOrchestrator` と依存組み立て手順を整理する。
  - 開始/終了タイムスタンプと処理件数をLogger等で記録し、Apps Script エラー通知と連携する。
  - _Requirements: 4.5_

- [x] 2. シート階層データアクセスを実装する
- [x] 2.1 (P) 親タスク行をロードし検証する
  - Project シートのヘッダを検証し、ProjectID/タイトル/オーナー/J列ThreadIDを取得できない場合はバリデーションエラーとして記録する。
  - 行インデックスを保持した `ParentRow` 構造体を返し、後続の J 列書き込みに備える。エラーメッセージは日本語で統一する。
  - _Requirements: 1.1, 1.5, 2.2_
- [x] 2.2 (P) 子タスク行の抽出とフィールド整形を行う
  - Task シートから ProjectID でフィルタした行をまとめて読み込み、タスクID・タイトル・担当者・期限・ステータス・完了日・備考を型整形する。
  - 必須項目欠落時の除外フラグと理由を保持し、通知層で参照できるようにする。JSDoc で戻り値フォーマットを明示する。
  - _Requirements: 1.2, 3.1, 3.3_
- [x] 2.3 (P) J列へのスレッドID書き戻しを実装する
  - `updateThreadId` で対象行の J 列を更新し、`SpreadsheetApp.flush()` で一括反映する。
  - 書き込み失敗時のリトライとロック（同一行の同時更新を避ける）を組み込む。
  - _Requirements: 2.2_

- [ ] 3. 完了率スナップショットサービスを構築する
- [x] 3.1 (P) 完了率算出ロジックを実装する
  - 子タスク配列から完了件数と総件数を集計し、ゼロ除算を避けつつ整数パーセントへ丸める。
  - 完了の定義（進行ステータス=完了）を定数化し、変更時に一元管理できるようにする。
  - _Requirements: 1.3, 1.4, 4.2, 4.3_
- [x] 3.2 (P) スナップショット保存と差分検知を行う
  - Script Properties に `{projectId: {total, done, percentage, lastPostedAt}}` を保存し、500KB制限を意識した圧縮・掃除ロジックを実装する。
  - 直近値との差分を判定して更新不要プロジェクトをスキップし、完了率の変化があった場合のみ true を返す。
  - _Requirements: 4.1, 4.4_

- [ ] 4. Discord フォーラムクライアントを実装する
- [x] 4.1 Thread 作成・再利用フローを整える
  - J列に threadId が無い場合は `POST /channels/{forumId}/threads` を呼び出し、新規スレッドIDを SheetHierarchyRepository に返す。
  - 既存 threadId があれば `POST /channels/{threadId}/messages` で追記し、同一プロジェクトで再利用する。
  - _Requirements: 2.1, 2.3_
- [x] 4.2 投稿・名称更新・完了率反映を実装する
  - NotificationFormatter から受け取った本文と embed を送信し、スレッド名を `ProjectID | 60%` 形式で `PATCH /channels/{threadId}` により更新する。
  - Discord の 2000 文字制限と 25MiB 上限に収まるようメッセージ分割／添付抑制を行う。
  - _Requirements: 3.1, 3.2, 3.4, 4.1, 4.2_
- [x] 4.3 エラー制御とバックオフを組み込む
  - 429/5xx 応答時に指数バックオフで最大3回リトライし、失敗した payload を再送キューとして Properties に格納する。
  - エラー詳細を Logger と Discord 管理チャンネルへ送信し、J列更新は成功時のみに限定する。
  - _Requirements: 2.4, 4.1_

- [x] 5. NotificationFormatter で通知本文を整形する
- [x] 5.1 ヘッダーと進捗メトリクスを生成する
  - プロジェクトID、同期日時、完了率（分子/分母含む）をヘッダーに組み込み、完了率0%時の特別文言を付与する。
  - メッセージ先頭に 最新同期時刻を表示する。
  - _Requirements: 3.4, 4.1, 4.2, 4.3_
- [x] 5.2 子タスク一覧と差分ハイライトを描画する
  - タスクID・タイトル・担当者・期限・ステータスを embed fields として整形し、もし多すぎる場合は複数メッセージに分割する。
  - 期限/ステータス変化がある行にマーカーを付け、必須項目欠落タスクを末尾に警告セクションとして列挙する。
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 6. TaskHierarchyService を実装する
- [x] 6. TaskHierarchyService を実装する
- [x] 6.1 (P) スナップショット生成パイプラインを組む
  - 親行をページング取得し、各プロジェクトについて子タスク配列・threadId・rowRef をまとめた `ProjectSnapshot` を構築する。
  - 完了率と差分情報を ProgressSnapshotService に問い合わせて Snapshot へ埋め込む。
  - _Requirements: 1.1, 1.2, 1.3, 1.4_
- [x] 6.2 (P) 差分検出と欠落データ処理を行う
  - 前回同期との差異を比較し、変更のあった子タスクのみを差分リストにまとめる。
  - 欠落データ行を通知対象から除外しつつ、Warning メッセージに載せるための説明を生成する。
  - _Requirements: 1.2, 3.2, 3.3_
- [x] 6.3 (P) Thread ID 管理と整合性チェックを提供する
  - DiscordForumClient から返った threadId を SheetHierarchyRepository の書き戻しAPIへ渡し、成功可否を戻り値で表現する。
  - threadId とスナップショットの整合が取れない場合は再取得フローを起動する。
  - _Requirements: 2.2, 2.3, 2.4_

- [ ] 7. Orchestrator と同期ループを仕上げる
- [x] 7. Orchestrator と同期ループを仕上げる
- [x] 7.1 同期サイクル制御ロジックを実装する
  - `syncCycle` で処理上限件数・carry-overキュー・リトライキューを参照し、プロジェクト単位で TaskHierarchyService→Discord→Sheet までの一連処理を流す。
  - 失敗プロジェクトは次回優先処理リストへ追記する。
  - _Requirements: 2.1, 2.3, 4.5_
- [x] 7.2 プログレス記録とログ整備を行う
  - 各プロジェクトの完了率更新結果、差分件数、送信メッセージIDをロギングし、Properties に lastSynced 時刻を格納する。
  - 監視用メトリクス（処理時間、API 呼び出し回数）をまとめ、閾値超過時に警告を投げる。
  - _Requirements: 4.1, 4.2, 4.4_
- [x] 7.3 J列更新とリカバリフローを統合する
  - 新規 threadId を受け取った際に SheetHierarchyRepository の更新が成功したか確認し、失敗時には Discord 側をロールバックせずに再実行待ちに設定する。
  - エラー内容を運用者に通知し、手動での J 列修正が必要な場合のガイダンスをログに残す。
  - _Requirements: 2.2, 2.4_

- [ ] 8. テストとパフォーマンス検証を実施する
- [x] 8. テストとパフォーマンス検証を実施する
- [x] 8.1 Core サービスの単体テストを作成する
  - ProgressSnapshotService、NotificationFormatter、TaskHierarchyService の主要関数に対しケース別テストを作り、完了率計算/差分判定/フォーマット整形を検証する。
  - _Requirements: 1.3, 1.4, 3.1, 3.2, 4.1_
- [x] 8.2 統合テストとスタブ環境を整える
  - Sheet と Discord クライアントのスタブを用意して `syncCycle` を通し、J列更新、スレッド再利用、エラー時スキップのシナリオを検証する。
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.1, 4.1_
- [x] 8.3 パフォーマンス/監視チェックを行う
  - 100 プロジェクト × 10 子タスクを想定したシミュレーションで 6 分制限内に完了するか測定し、必要に応じて carry-over パラメータを調整する。
  - 監視ログと再送キューのメトリクスをレビューし、閾値設定が妥当か確認する。
  - _Requirements: 4.1, 4.5_
